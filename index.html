<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading Noloco Record</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            padding: 20px;
            margin: 0;
            background: #f5f5f5;
        }
        .loading {
            text-align: center;
            padding: 40px 20px;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 15px;
            margin: 20px;
            color: #856404;
        }
        .error h3 {
            margin-top: 0;
        }
        .debug {
            background: #e7f3ff;
            border: 1px solid #2196F3;
            border-radius: 4px;
            padding: 15px;
            margin: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow: auto;
        }
    </style>
</head>
<body>
    <div class="loading">
        <div class="spinner"></div>
        <p>Loading Noloco record...</p>
        <p style="font-size: 12px; color: #666;">Waiting for Front context...</p>
    </div>

    <script>
        // Noloco configuration
        const NOLOCO_CONFIG = {
            baseUrl: 'https://xpertfunding.noloco.co',
            collectionPath: '%F0%9F%92%B0-funding-database/view',
            parentPage: 'eyJlbGVtZW50SWQiOiJ2ZXc1ZU1mbzVXSzlqaExJdWJfRXZVMVYiLCJlbmFibGVkIjp0cnVlLCJwYXJhbXMiOnt9fQ%3D%3D'
        };

        let debugLog = [];
        function log(message, data = null) {
            console.log(message, data);
            debugLog.push(`${message} ${data ? JSON.stringify(data, null, 2) : ''}`);
        }

        function showError(message) {
            document.body.innerHTML = `
                <div class="error">
                    <h3>⚠️ Cannot Load Record</h3>
                    <p>${message}</p>
                </div>
                <div class="debug">
                    <strong>Debug Log:</strong><br>
                    ${debugLog.join('<br>')}
                </div>
            `;
        }

        function buildNolocoUrl(recordId) {
            const url = `${NOLOCO_CONFIG.baseUrl}/${NOLOCO_CONFIG.collectionPath}/${recordId}?_parentPage=${NOLOCO_CONFIG.parentPage}`;
            return url;
        }

        // Wait for Front SDK to load
        function initializeFront() {
            log('Checking if Front SDK is available...');
            
            if (typeof Front === 'undefined') {
                log('Front SDK not loaded yet, retrying...');
                setTimeout(initializeFront, 500);
                return;
            }

            log('Front SDK loaded successfully!');

            // Try different initialization methods
            
            // Method 1: contextUpdates.subscribe
            try {
                log('Trying Method 1: contextUpdates.subscribe');
                Front.contextUpdates.subscribe(context => {
                    log('Method 1 - Received context', context);
                    handleContext(context);
                });
            } catch (e) {
                log('Method 1 failed', e.message);
            }

            // Method 2: Direct context access
            try {
                log('Trying Method 2: Direct context access');
                setTimeout(() => {
                    if (Front.context) {
                        log('Method 2 - Found context directly', Front.context);
                        handleContext(Front.context);
                    } else {
                        log('Method 2 - No direct context available');
                    }
                }, 1000);
            } catch (e) {
                log('Method 2 failed', e.message);
            }

            // Method 3: Listen for messages
            try {
                log('Trying Method 3: Window message listener');
                window.addEventListener('message', (event) => {
                    log('Received window message', event.data);
                    if (event.data && event.data.context) {
                        log('Method 3 - Found context in message');
                        handleContext(event.data.context);
                    }
                });
            } catch (e) {
                log('Method 3 failed', e.message);
            }
        }

        function handleContext(context) {
            try {
                log('Processing context', context);
                
                // Check if conversation exists
                if (!context || !context.conversation) {
                    showError('No conversation context found.');
                    return;
                }

                log('Conversation found', context.conversation);

                // Get custom fields
                const customFields = context.conversation.custom_fields || {};
                log('Custom fields object', customFields);
                log('Available custom field keys', Object.keys(customFields));

                // Try multiple possible key names
                const recordId = customFields['Airtable Record ID'] 
                              || customFields['airtable_record_id']
                              || customFields['airtableRecordId']
                              || customFields['fld_orx4'];

                if (!recordId) {
                    const availableKeys = Object.keys(customFields);
                    showError(`No Airtable Record ID found.<br><br>Available custom field keys: ${availableKeys.length > 0 ? availableKeys.join(', ') : 'None'}<br><br>Custom fields object: ${JSON.stringify(customFields, null, 2)}`);
                    return;
                }

                log('Found record ID', recordId);

                // Build URL and redirect
                const nolocoUrl = buildNolocoUrl(recordId);
                log('Redirecting to', nolocoUrl);
                window.location.href = nolocoUrl;

            } catch (error) {
                log('Error in handleContext', error.message);
                console.error('Full error:', error);
                showError(`An error occurred: ${error.message}`);
            }
        }

        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeFront);
        } else {
            initializeFront();
        }

        // Timeout fallback
        setTimeout(() => {
            if (document.querySelector('.loading')) {
                showError('Failed to initialize Front plugin after 10 seconds. The Front SDK may not be loading properly.');
            }
        }, 10000);
    </script>
    
    <!-- Front SDK - try multiple versions -->
    <script src="https://dl.frontapp.com/libs/frontjs.min.js"></script>
</body>
</html>
