<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noloco Redirect</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .status {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 4px;
            color: #856404;
        }
        .debug {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="status">
        <div class="spinner"></div>
        <p id="status">Loading conversation...</p>
    </div>
    <div class="debug" id="debug"></div>

    <script>
        const CONFIG = {
            nolocoBase: 'https://xpertfunding.noloco.co',
            nolocoPath: '%F0%9F%92%B0-funding-database/view',
            parentPage: 'eyJlbGVtZW50SWQiOiJ2ZXc1ZU1mbzVXSzlqaExJdWJfRXZVMVYiLCJlbmFibGVkIjp0cnVlLCJwYXJhbXMiOnt9fQ%3D%3D',
            apiToken: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjb250ZXh0IjoiY252XzFmZ3ljeTZ3In0.REPLACE_WITH_YOUR_TOKEN' // Replace with actual API token
        };

        let debugOutput = [];
        
        function log(msg, data) {
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const line = `[${timestamp}] ${msg}${data ? '\n' + JSON.stringify(data, null, 2) : ''}`;
            debugOutput.push(line);
            document.getElementById('debug').textContent = debugOutput.join('\n\n');
            console.log(msg, data);
        }

        function updateStatus(msg) {
            document.getElementById('status').textContent = msg;
        }

        function showError(msg) {
            document.querySelector('.status').innerHTML = `
                <div class="error">
                    <h3>Cannot Load Record</h3>
                    <p>${msg}</p>
                </div>
            `;
        }

        function redirect(recordId) {
            const url = `${CONFIG.nolocoBase}/${CONFIG.nolocoPath}/${recordId}?_parentPage=${CONFIG.parentPage}`;
            log('Redirecting to:', url);
            updateStatus('Redirecting to Noloco...');
            window.location.href = url;
        }

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const authSecret = urlParams.get('auth_secret');
        
        log('Auth secret from URL:', authSecret);
        log('Full URL:', window.location.href);

        // Try to extract conversation ID from parent iframe
        async function getConversationFromParent() {
            log('Attempting to get conversation from parent window...');
            
            return new Promise((resolve) => {
                let resolved = false;
                
                window.addEventListener('message', (event) => {
                    if (resolved) return;
                    
                    log('Received message from parent:', event.data);
                    
                    if (event.data && event.data.conversation) {
                        resolved = true;
                        resolve(event.data.conversation);
                    } else if (event.data && event.data.context && event.data.context.conversation) {
                        resolved = true;
                        resolve(event.data.context.conversation);
                    }
                });

                // Request context from parent
                if (window.parent && window.parent !== window) {
                    log('Requesting context from parent...');
                    window.parent.postMessage({ type: 'getContext' }, '*');
                    window.parent.postMessage({ type: 'front:getConversation' }, '*');
                }

                // Timeout after 3 seconds
                setTimeout(() => {
                    if (!resolved) {
                        resolved = true;
                        resolve(null);
                    }
                }, 3000);
            });
        }

        // Main execution
        async function main() {
            updateStatus('Looking for conversation data...');
            
            // Try getting from parent
            const conversation = await getConversationFromParent();
            
            if (conversation) {
                log('✓ Got conversation from parent!', conversation);
                
                const customFields = conversation.custom_fields || {};
                log('Custom fields:', customFields);
                
                const recordId = customFields['Airtable Record ID'] 
                              || customFields['airtable_record_id']
                              || customFields['airtableRecordId'];
                
                if (recordId) {
                    log('✓ Found record ID:', recordId);
                    redirect(recordId);
                } else {
                    log('✗ No Airtable Record ID in custom fields');
                    showError('No Airtable Record ID found in this conversation. Available fields: ' + Object.keys(customFields).join(', '));
                }
            } else {
                log('✗ Could not get conversation from parent');
                showError('Unable to load conversation context. Make sure this plugin is opened from within a conversation view in Front.');
            }
        }

        main();
    </script>
</body>
</html>
