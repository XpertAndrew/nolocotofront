<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noloco Redirect</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .status {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .debug {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="status">
        <div class="spinner"></div>
        <p id="status">Initializing...</p>
    </div>
    <div class="debug" id="debug"></div>

    <script src="https://dl.frontapp.com/libs/frontjs.min.js"></script>
    <script>
        // Configuration
        const CONFIG = {
            nolocoBase: 'https://xpertfunding.noloco.co',
            nolocoPath: '%F0%9F%92%B0-funding-database/view',
            parentPage: 'eyJlbGVtZW50SWQiOiJ2ZXc1ZU1mbzVXSzlqaExJdWJfRXZVMVYiLCJlbmFibGVkIjp0cnVlLCJwYXJhbXMiOnt9fQ%3D%3D'
        };

        let debugOutput = [];
        
        function log(msg, data) {
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const line = `[${timestamp}] ${msg}${data ? '\n' + JSON.stringify(data, null, 2) : ''}`;
            debugOutput.push(line);
            document.getElementById('debug').textContent = debugOutput.join('\n\n');
            console.log(msg, data);
        }

        function updateStatus(msg) {
            document.getElementById('status').textContent = msg;
        }

        function redirect(recordId) {
            const url = `${CONFIG.nolocoBase}/${CONFIG.nolocoPath}/${recordId}?_parentPage=${CONFIG.parentPage}`;
            log('Redirecting to:', url);
            updateStatus('Redirecting to Noloco...');
            window.location.href = url;
        }

        // Wait for Front to be available
        let attempts = 0;
        function checkFront() {
            attempts++;
            log(`Attempt ${attempts}: Checking for Front SDK...`);
            
            if (typeof Front === 'undefined') {
                if (attempts < 20) {
                    setTimeout(checkFront, 500);
                } else {
                    updateStatus('ERROR: Front SDK not loading');
                    log('ERROR: Front SDK never loaded after 10 seconds');
                }
                return;
            }

            log('✓ Front SDK loaded!');
            log('Front object properties:', Object.keys(Front));
            log('Front object:', Front);
            
            // Try all possible methods
            tryAllMethods();
        }

        function tryAllMethods() {
            updateStatus('Looking for conversation context...');

            // Method 1: Check if Front has getContext
            if (typeof Front.getContext === 'function') {
                log('Trying: Front.getContext()');
                try {
                    Front.getContext().then(ctx => {
                        log('✓ Front.getContext() returned:', ctx);
                        processContext(ctx);
                    }).catch(err => {
                        log('✗ Front.getContext() error:', err.message);
                    });
                } catch (e) {
                    log('✗ Front.getContext() failed:', e.message);
                }
            } else {
                log('✗ Front.getContext is not a function');
            }

            // Method 2: Check Front.context directly
            if (Front.context) {
                log('✓ Found Front.context:', Front.context);
                processContext(Front.context);
            } else {
                log('✗ Front.context is undefined');
            }

            // Method 3: Listen for postMessage
            log('Setting up postMessage listener...');
            window.addEventListener('message', (event) => {
                log('Received postMessage from:', event.origin);
                log('postMessage data:', event.data);
                
                if (event.data && typeof event.data === 'object') {
                    if (event.data.conversation) {
                        log('✓ Found conversation in postMessage');
                        processContext(event.data);
                    }
                }
            });

            // Method 4: Check if there's an on/addEventListener
            if (typeof Front.on === 'function') {
                log('Trying: Front.on()');
                try {
                    Front.on('*', (data) => {
                        log('Front.on received:', data);
                        processContext(data);
                    });
                } catch (e) {
                    log('✗ Front.on failed:', e.message);
                }
            }

            // Request context from parent
            log('Requesting context from parent window...');
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({ type: 'getContext' }, '*');
                window.parent.postMessage({ type: 'front:requestContext' }, '*');
            }
        }

        function processContext(context) {
            log('Processing context:', context);
            updateStatus('Processing context...');

            if (!context || !context.conversation) {
                log('✗ No conversation in context');
                updateStatus('ERROR: No conversation found');
                return;
            }

            const conv = context.conversation;
            log('Conversation ID:', conv.id);
            log('Custom fields:', conv.custom_fields);

            const customFields = conv.custom_fields || {};
            const keys = Object.keys(customFields);
            log('Available custom field keys:', keys);

            // Try to find record ID
            const recordId = customFields['Airtable Record ID'] 
                          || customFields['airtable_record_id']
                          || customFields['airtableRecordId']
                          || customFields['fld_orx4'];

            if (recordId) {
                log('✓ Found Record ID:', recordId);
                redirect(recordId);
            } else {
                updateStatus('ERROR: No Airtable Record ID found');
                log('✗ No Record ID found in custom fields');
                log('Custom fields content:', customFields);
            }
        }

        // Start
        checkFront();
    </script>
</body>
</html>
